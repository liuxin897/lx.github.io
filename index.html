<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>淘宝店铺财务模型 V3.0 (精细化成本版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f1f5f9; height: 100vh; overflow: hidden; }
        .sidebar { background-color: #fff; border-right: 1px solid #e2e8f0; height: 100vh; overflow-y: auto; }
        .main-content { height: 100vh; overflow-y: auto; }
        
        /* 输入框样式 */
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.7rem; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 0.25rem; }
        .input-group input { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.9rem; color: #334155; transition: all 0.2s; }
        .input-group input:focus { outline: none; border-color: #3b82f6; ring: 3px solid #eff6ff; }
        
        /* 标题分割线 */
        .section-header { font-size: 0.75rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem; margin-bottom: 1rem; margin-top: 1.5rem; }
        
        /* 卡片样式 */
        .stat-card { background: white; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); border: 1px solid #f1f5f9; position: relative; transition: all 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; }
        .card-select { position: absolute; top: 1rem; right: 1rem; font-size: 0.75rem; color: #94a3b8; border: none; background: transparent; cursor: pointer; text-align: right; }
        .card-select:focus { outline: none; color: #3b82f6; }
        
        /* 表格样式 */
        .finance-table { width: 100%; font-size: 0.85rem; border-collapse: separate; border-spacing: 0; }
        .finance-table th { background: #f8fafc; color: #475569; font-weight: 600; padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; font-size: 0.75rem; text-transform: uppercase; }
        .finance-table th:first-child { text-align: left; padding-left: 1.5rem; }
        .finance-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; text-align: right; color: #334155; }
        .finance-table td:first-child { text-align: left; font-weight: 500; color: #1e293b; padding-left: 1.5rem; }
        .finance-table tr:hover td { background-color: #f8fafc; }
        .sub-row td { font-size: 0.8rem; color: #64748b; padding-top: 0.25rem; padding-bottom: 0.25rem; border-bottom: none; }
        .sub-row td:first-child { padding-left: 2.5rem; font-weight: 400; }
    </style>
</head>
<body class="flex">

    <!-- 左侧参数设置区 (1/5) -->
    <div class="sidebar w-1/5 p-5 flex flex-col">
        <h2 class="text-xl font-bold text-slate-800 mb-2">财务模型 <span class="text-blue-600">Pro</span></h2>
        <p class="text-xs text-slate-400 mb-6">目标倒推 · 履约分离 · 流量结构</p>

        <!-- 1. 目标设定 -->
        <div class="section-header">1. 目标设定 (Target)</div>
        <div class="input-group">
            <label>目标净利润</label>
            <input type="number" id="targetProfit" value="300000" oninput="calculate()">
        </div>
        <div class="input-group">
            <label>目标净利率 (%)</label>
            <input type="number" id="targetProfitRate" value="15" oninput="calculate()">
        </div>

        <!-- 2. 商品与履约 -->
        <div class="section-header">2. 商品与履约 (Fulfillment)</div>
        <div class="input-group">
            <label>目标毛利率 (%)</label>
            <input type="number" id="grossMargin" value="50" oninput="calculate()">
            <div class="text-[10px] text-slate-400 mt-1">*(销售价-进货价)/销售价</div>
        </div>
        <div class="flex gap-2">
            <div class="input-group w-1/2">
                <label>快递费 (元/单)</label>
                <input type="number" id="courierFee" value="1.7" oninput="calculate()">
            </div>
            <div class="input-group w-1/2">
                <label>操作费 (元/单)</label>
                <input type="number" id="handlingFee" value="0.7" oninput="calculate()">
            </div>
        </div>

        <!-- 3. 流量结构 -->
        <div class="section-header">3. 流量与转化 (Traffic)</div>
        <div class="input-group">
            <label>免费流量占比 (%)</label>
            <input type="number" id="freeTrafficRate" value="70" oninput="calculate()">
        </div>
        <div class="flex gap-2">
            <div class="input-group w-1/2">
                <label>客单价 (AOV)</label>
                <input type="number" id="aov" value="200" oninput="calculate()">
            </div>
            <div class="input-group w-1/2">
                <label>转化率 (%)</label>
                <input type="number" id="cvr" value="3.0" step="0.1" oninput="calculate()">
            </div>
        </div>
        <div class="input-group">
            <label>退货率 (%)</label>
            <input type="number" id="returnRate" value="15" oninput="calculate()">
        </div>

        <!-- 4. 固定支出 -->
        <div class="section-header">4. 其它支出 (Opex)</div>
        <div class="input-group">
            <label>年度管理费</label>
            <input type="number" id="adminFee" value="190000" oninput="calculate()">
        </div>
        <div class="input-group">
            <label>损耗占比 (% of GMV)</label>
            <input type="number" id="wastageRate" value="2" oninput="calculate()">
        </div>
        <div class="input-group">
            <label class="text-blue-600">税率 (基于净GMV)</label>
            <input type="text" value="固定 6.5%" readonly class="bg-blue-50 text-blue-600 font-bold border-blue-100">
        </div>
    </div>

    <!-- 右侧内容区 (4/5) -->
    <div class="main-content w-4/5 p-8 bg-slate-50">
        
        <!-- 核心卡片 -->
        <div class="grid grid-cols-4 gap-4 mb-6" id="cardContainer">
            <!-- Cards injected by JS -->
        </div>

        <!-- 报表 -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">店铺年度损益预估表</h3>
                <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">Model: Target-Driven</span>
            </div>
            <div class="overflow-x-auto">
                <table class="finance-table">
                    <thead>
                        <tr>
                            <th class="w-1/4">项目</th>
                            <th class="w-1/6">单日数据</th>
                            <th class="w-1/6">月度数据</th>
                            <th class="w-1/6">年度数据</th>
                            <th class="w-1/6">占比 (Ratio)</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- Table Rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 定义卡片选项
        const metricOptions = [
            { key: 'roi', label: '目标 ROI' },
            { key: 'breakEvenRoi', label: '保本 ROI (生死线)' },
            { key: 'ppc', label: '付费PPC上限' },
            { key: 'dailyGmv', label: '每日销售额' },
            { key: 'marketingBudget', label: '年度推广预算' },
            { key: 'annualOrders', label: '年度总单量' }
        ];

        // 默认显示的卡片
        let cardConfig = ['roi', 'breakEvenRoi', 'ppc', 'dailyGmv'];
        let results = {};

        function init() {
            renderCards();
            calculate();
        }

        const fmtMoney = (n) => '¥' + n.toLocaleString('zh-CN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const fmtPct = (n) => n.toFixed(2) + '%';

        function calculate() {
            // --- 1. 获取输入参数 ---
            const targetNetProfit = parseFloat(document.getElementById('targetProfit').value) || 0;
            const targetNetRate = parseFloat(document.getElementById('targetProfitRate').value) / 100 || 0.15;
            
            const grossMargin = parseFloat(document.getElementById('grossMargin').value) / 100 || 0;
            const courierFee = parseFloat(document.getElementById('courierFee').value) || 0;
            const handlingFee = parseFloat(document.getElementById('handlingFee').value) || 0;
            
            const freeTrafficRate = parseFloat(document.getElementById('freeTrafficRate').value) / 100 || 0;
            const aov = parseFloat(document.getElementById('aov').value) || 0;
            const cvr = parseFloat(document.getElementById('cvr').value) / 100 || 0;
            const returnRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0;
            
            const adminFee = parseFloat(document.getElementById('adminFee').value) || 0;
            const wastageRate = parseFloat(document.getElementById('wastageRate').value) / 100 || 0;
            
            // --- 2. 基础倒推逻辑 ---
            // 年度GMV = 目标净利 / 目标净利率
            const annualGmv = targetNetRate > 0 ? targetNetProfit / targetNetRate : 0;
            const dailyGmv = annualGmv / 360;

            // 订单量计算 (总单量，含退货)
            const annualOrders = aov > 0 ? annualGmv / aov : 0;

            // 退货与净销售
            const annualReturnVal = annualGmv * returnRate;
            const annualNetGmv = annualGmv - annualReturnVal;

            // --- 3. 成本计算 (核心细化部分) ---
            
            // A. 货品 COGS (Cost of Goods Sold)
            // 逻辑：毛利通常基于净销售额。货品成本 = 净销售额 * (1 - 毛利率)
            // 这代表真正卖出去的货的进货价
            const annualCogs = annualNetGmv * (1 - grossMargin);

            // B. 履约成本 (Fulfillment)
            // 逻辑：每发一单都要给快递和打包费，无论是否退货。
            // 履约成本 = 总单量 * (快递+操作)
            const fulfillmentPerOrder = courierFee + handlingFee;
            const annualFulfillment = annualOrders * fulfillmentPerOrder;

            // C. 税费 (基于净GMV)
            const annualTax = annualNetGmv * 0.065;

            // D. 损耗 (基于总GMV)
            const annualWastage = annualGmv * wastageRate;

            // --- 4. 推广预算倒推 (The Plug) ---
            // 净利 = 净销售 - COGS - 履约 - 税 - 损耗 - 管理 - 推广
            // 推广 = 净销售 - COGS - 履约 - 税 - 损耗 - 管理 - 净利
            const annualMarketing = annualNetGmv - annualCogs - annualFulfillment - annualTax - annualWastage - adminFee - targetNetProfit;

            // --- 5. 衍生指标计算 ---
            
            // 商品利润 (定义：毛利 - 推广)
            // 这里的“毛利”通常指会计毛利(Revenue - COGS)，不含履约
            const annualGrossProfit = annualNetGmv - annualCogs;
            const itemProfit = annualGrossProfit - annualMarketing;

            // ROI
            const roi = annualMarketing > 0 ? annualGmv / annualMarketing : 0;

            // 保本 ROI (Break-even ROI)
            // 逻辑：当净利润为0时，推广费可以是现在的推广费 + 现在的目标净利
            const maxMarketingAtBreakEven = annualMarketing + targetNetProfit;
            const breakEvenRoi = maxMarketingAtBreakEven > 0 ? annualGmv / maxMarketingAtBreakEven : 999;

            // PPC 计算 (含免费流量结构)
            // 总流量(UV) = 订单 / 转化率
            const totalTraffic = cvr > 0 ? annualOrders / cvr : 0;
            // 付费流量 = 总流量 * (1 - 免费占比)
            const paidTraffic = totalTraffic * (1 - freeTrafficRate);
            
            let ppc = 0;
            if (paidTraffic > 0 && annualMarketing > 0) {
                ppc = annualMarketing / paidTraffic;
            }

            // --- 6. 存储结果 ---
            results = {
                roi: roi,
                breakEvenRoi: breakEvenRoi,
                ppc: ppc,
                dailyGmv: dailyGmv,
                marketingBudget: annualMarketing,
                annualOrders: annualOrders
            };

            updateCardsData();

            // --- 7. 构建报表数据 ---
            const tableData = [
                { name: 'GMV (销售额)', val: annualGmv, isBold: true },
                { name: '(-) 退货', val: annualReturnVal, color: 'text-red-500' },
                { name: '= 净销售额 (Net Sales)', val: annualNetGmv, bg: 'bg-blue-50', isBold: true },
                
                // 货品成本
                { name: '(-) 货品COGS (进货价)', val: annualCogs, color: 'text-slate-500', note: 'Net GMV × (1-毛利率)' },
                
                // 履约成本 (拆分显示)
                { name: '(-) 履约成本 (快递+操作)', val: annualFulfillment, color: 'text-slate-500', isSubHeader: true },
                { name: '快递费', val: annualOrders * courierFee, isSubRow: true },
                { name: '操作费', val: annualOrders * handlingFee, isSubRow: true },

                // 费用
                { name: '(-) 推广费 (倒推预算)', val: annualMarketing, color: 'text-orange-600', isBold: true, note: '剩余可用预算' },
                { name: '(-) 税费', val: annualTax, color: 'text-slate-400', note: 'Net GMV × 6.5%' },
                { name: '(-) 损耗', val: annualWastage, color: 'text-slate-400' },
                { name: '(-) 管理费', val: adminFee, color: 'text-slate-400' },
                
                // 结果
                { name: '= 净利润', val: targetNetProfit, color: 'text-green-600', bg: 'bg-green-50', isBold: true, isTotal: true }
            ];

            renderTable(tableData, annualGmv);
        }

        // --- UI 渲染函数 ---

        function renderCards() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';
            
            cardConfig.forEach((key, index) => {
                const div = document.createElement('div');
                div.className = 'stat-card';
                div.innerHTML = `
                    <select class="card-select" onchange="changeCard(${index}, this.value)">
                        ${metricOptions.map(opt => `<option value="${opt.key}" ${opt.key === key ? 'selected' : ''}>${opt.label}</option>`).join('')}
                    </select>
                    <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mt-1 mb-2" id="card-label-${index}">
                        ${metricOptions.find(o => o.key === key).label}
                    </div>
                    <div class="text-2xl font-bold text-slate-700 truncate" id="card-val-${index}">-</div>
                    <div class="text-xs text-slate-400 mt-2 font-medium" id="card-sub-${index}">...</div>
                `;
                container.appendChild(div);
            });
        }

        function updateCardsData() {
            cardConfig.forEach((key, index) => {
                const valEl = document.getElementById(`card-val-${index}`);
                const subEl = document.getElementById(`card-sub-${index}`);
                const label = metricOptions.find(o => o.key === key).label;
                document.getElementById(`card-label-${index}`).innerText = label;

                let displayVal = '0';
                let subText = '';
                let valColor = 'text-slate-700';

                if (key === 'roi') {
                    displayVal = results.roi.toFixed(2);
                    // 逻辑：ROI越高越难。如果ROI要求 > 6，标红提醒
                    if(results.roi > 6) valColor = 'text-red-500'; 
                    else if (results.roi < results.breakEvenRoi) valColor = 'text-red-500'; // 亏本
                    else valColor = 'text-green-600';
                    subText = '为达标所需ROI';
                } else if (key === 'breakEvenRoi') {
                    displayVal = results.breakEvenRoi.toFixed(2);
                    subText = '低于此值即亏损';
                    valColor = 'text-orange-500';
                } else if (key === 'ppc') {
                    displayVal = '¥' + results.ppc.toFixed(2);
                    subText = `基于${document.getElementById('freeTrafficRate').value}%免费流量`;
                    if(results.ppc < 0.5) valColor = 'text-red-500'; // 出价太低很难买到量
                } else if (key === 'dailyGmv') {
                    displayVal = fmtMoney(results.dailyGmv);
                    subText = '日均目标';
                } else if (key === 'marketingBudget') {
                    displayVal = fmtMoney(results.marketingBudget);
                    valColor = results.marketingBudget < 0 ? 'text-red-500' : 'text-blue-600';
                    subText = results.marketingBudget < 0 ? '预算不足!' : '年度总预算';
                } else if (key === 'annualOrders') {
                    displayVal = Math.round(results.annualOrders).toLocaleString();
                    subText = '单 (含退货)';
                }

                valEl.className = `text-2xl font-bold truncate ${valColor}`;
                valEl.innerText = displayVal;
                subEl.innerText = subText;
            });
        }

        function changeCard(index, newKey) {
            cardConfig[index] = newKey;
            updateCardsData();
        }

        function renderTable(data, totalGmv) {
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                if (row.bg) tr.className = row.bg;
                if (row.isSubRow) tr.className = 'sub-row';
                
                const daily = row.val / 360;
                const monthly = row.val / 12;
                const annual = row.val;
                
                let ratio = totalGmv > 0 ? (row.val / totalGmv * 100) : 0;
                
                const valClass = row.color || 'text-slate-600';
                const fontClass = row.isBold ? 'font-bold' : '';

                // 子行不显示日/月数据，简化视觉
                const displayDaily = row.isSubRow ? '-' : fmtMoney(daily);
                const displayMonthly = row.isSubRow ? '-' : fmtMoney(monthly);

                tr.innerHTML = `
                    <td>
                        <div class="${row.isTotal ? 'text-base' : 'text-sm'} ${row.isBold ? 'font-bold text-slate-800' : ''}">
                            ${row.name}
                        </div>
                        ${row.note ? `<div class="text-[10px] text-slate-400 font-normal mt-0.5">${row.note}</div>` : ''}
                    </td>
                    <td class="${valClass} ${fontClass}">${displayDaily}</td>
                    <td class="${valClass} ${fontClass}">${displayMonthly}</td>
                    <td class="${valClass} ${fontClass} text-slate-800 bg-opacity-50">${fmtMoney(annual)}</td>
                    <td class="text-slate-400 text-xs">${row.isSubRow ? '' : fmtPct(ratio)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        init();
    </script>
</body>

</html>
