<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—é“ºè¿è¥è´¢åŠ¡æ¨¡å‹ V3.1 - å®æ—¶ROIç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f8fafc; height: 100vh; overflow: hidden; }
        .sidebar { background-color: #fff; border-right: 1px solid #e2e8f0; height: 100vh; overflow-y: auto; }
        .main-content { height: 100vh; overflow-y: auto; }
        
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.7rem; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 0.25rem; }
        .input-group input { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.9rem; color: #0f172a; transition: all 0.2s; }
        .input-group input:focus { outline: none; border-color: #f97316; ring: 3px solid #ffedd5; }
        
        .section-header { font-size: 0.75rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem; margin-bottom: 1rem; margin-top: 1.5rem; }
        
        /* æ¨¡å¼åˆ‡æ¢å™¨ */
        .mode-switch { background: #f1f5f9; padding: 4px; border-radius: 8px; display: flex; margin-bottom: 20px; }
        .mode-btn { flex: 1; text-align: center; padding: 8px; font-size: 0.8rem; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s; color: #64748b; }
        .mode-btn.active { background: white; color: #0f172a; shadow: 0 1px 2px rgba(0,0,0,0.1); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .mode-btn:hover:not(.active) { color: #475569; }

        /* æ ¸å¿ƒå¡ç‰‡ */
        .stat-card { background: white; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; position: relative; display: flex; flex-direction: column; justify-content: center; min-height: 140px; }
        .card-select { position: absolute; top: 1rem; right: 1rem; font-size: 0.75rem; color: #94a3b8; border: none; background: transparent; cursor: pointer; text-align: right; max-width: 100px; }
        
        /* è¡¨æ ¼ä¼˜åŒ– */
        .finance-table { width: 100%; font-size: 0.85rem; border-collapse: separate; border-spacing: 0; }
        .finance-table th { background: #f8fafc; color: #475569; font-weight: 600; padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; }
        .finance-table th:first-child { text-align: left; padding-left: 1.5rem; }
        .finance-table td { padding: 0.6rem 1rem; border-bottom: 1px solid #f1f5f9; text-align: right; color: #334155; }
        .finance-table td:first-child { text-align: left; padding-left: 1.5rem; font-weight: 500; }
        
        .sub-row td { font-size: 0.75rem; color: #94a3b8; border-bottom: 1px dashed #f1f5f9; padding-top: 0.4rem; padding-bottom: 0.4rem; }
        .sub-row td:first-child { padding-left: 2.5rem; }

        /* åŠ¨æ€æ˜¾éš */
        .hidden-group { display: none; }

        /* æ‰“èµæ¨¡æ€æ¡†åŠ¨ç”» */
        #donateModal { transition: opacity 0.3s ease-in-out; }
        #donateModal.hidden { display: none; opacity: 0; }
        #donateModal:not(.hidden) { display: flex; opacity: 1; }

        
    </style>
</head>
<body class="flex">

    <!-- å·¦ä¾§å‚æ•° -->
    <div class="sidebar w-1/5 p-5 flex flex-col">
        <div>
            <h2 class="text-xl font-bold text-slate-800 mb-4">åº—é“ºè¿è¥è´¢åŠ¡æ¨¡å‹ <span class="text-blue-600 text-sm">V3.1</span></h2>
            
            <!-- æ¨¡å¼åˆ‡æ¢ -->
            <div class="mode-switch">
                <div class="mode-btn active" id="btnModeTarget" onclick="switchMode('target')">ğŸ¯ åˆ©æ¶¦å€’æ¨</div>
                <div class="mode-btn" id="btnModeProject" onclick="switchMode('project')">ğŸ“ˆ è¿è¥é¢„æµ‹</div>
            </div>

            <!-- 1. æ ¸å¿ƒå˜é‡ (æ ¹æ®æ¨¡å¼å˜åŒ–) -->
            <div class="section-header" id="section1Title">1. åˆ©æ¶¦ç›®æ ‡</div>
            
            <!-- æ¨¡å¼Aï¼šå€’æ¨è¾“å…¥ -->
            <div id="groupTargetMode">
                <div class="input-group">
                    <label>ç›®æ ‡å‡€åˆ©æ¶¦ (å¹´åº¦)</label>
                    <input type="number" id="targetProfit" value="500000" oninput="calculate()">
                </div>
                <div class="input-group">
                    <label>ç›®æ ‡å‡€åˆ©ç‡ (%)</label>
                    <input type="number" id="targetProfitRate" value="15" oninput="calculate()">
                </div>
            </div>

            <!-- æ¨¡å¼Bï¼šé¢„æµ‹è¾“å…¥ (ä¿®æ”¹ç‚¹ï¼šæ”¹ä¸ºå®æ—¶ROI) -->
            <div id="groupProjectMode" class="hidden-group">
                <div class="input-group">
                    <label class="text-blue-600">æ—¥å‡æ¨å¹¿é¢„ç®—</label>
                    <input type="number" id="dailyAdSpend" value="2000" oninput="calculate()" class="border-blue-200">
                </div>
                <div class="input-group">
                    <label class="text-blue-600">å½“å¤©å®æ—¶ ROI</label>
                    <input type="number" id="realtimeRoiInput" value="2.3" step="0.1" oninput="calculate()" class="border-blue-200 font-bold">
                    <div class="text-[10px] text-blue-500 mt-1 flex justify-between">
                        <span>Ã— è†¨èƒ€ç³»æ•° = ç»“ç®—ROI: <span id="finalRoiPreview" class="font-bold">--</span></span>
                    </div>
                </div>
            </div>

            <!-- 2. å•†å“æ¨¡å‹ (é€šç”¨) -->
            <div class="section-header">2. å•†å“ä¸å±¥çº¦</div>
            <div class="input-group p-2 rounded border bg-slate-50">
                <label>å®é™…æ¯›åˆ©ç‡ (%)</label>
                <input type="number" id="grossMargin" value="50" oninput="calculate()" class="bg-white">
                <div class="text-[10px] text-slate-400 mt-1">
                    *å·²æ‰£é™¤è¿è´¹åçš„æ¯›åˆ©
                </div>
            </div>
            <div class="flex gap-2">
                <div class="input-group w-1/2">
                    <label>å¿«é€’+æ‰“åŒ…</label>
                    <input type="number" id="fulfillmentFee" value="2.4" oninput="calculate()">
                </div>
                <div class="input-group w-1/2">
                    <label>å®¢å•ä»· (AOV)</label>
                    <input type="number" id="aov" value="65" oninput="calculate()">
                </div>
            </div>

            <!-- 3. æµé‡ç»“æ„ (é€šç”¨) -->
            <div class="section-header">3. æµé‡ä¸æ¨å¹¿</div>
            <div class="input-group">
                <label>å…è´¹æµé‡å æ¯” (%)</label>
                <input type="number" id="freeTrafficRate" value="30" oninput="calculate()">
            </div>
            <!-- è†¨èƒ€ç³»æ•° -->
            <div class="input-group bg-orange-50 p-2 rounded border border-orange-100">
                <label class="text-orange-800">æ¨å¹¿ROIè†¨èƒ€ç³»æ•°</label>
                <input type="number" id="roiInflation" value="1.51" step="0.01" oninput="calculate()" class="border-orange-200 text-orange-800 font-bold">
                <div class="text-[10px] text-orange-600 mt-1">
                    å…¬å¼ï¼š15å¤©æœ€ç»ˆROI Ã· å½“å¤©å®æ—¶ROI
                </div>
            </div>
            <div class="input-group">
                <label>è½¬åŒ–ç‡ (%)</label>
                <input type="number" id="cvr" value="6.0" step="0.1" oninput="calculate()">
            </div>
            <div class="input-group">
                <label>é€€è´§ç‡ (%)</label>
                <input type="number" id="returnRate" value="25" oninput="calculate()">
            </div>

            <!-- 4. å›ºå®šæ”¯å‡º (é€šç”¨) -->
            <div class="section-header">4. å…¶å®ƒæˆæœ¬</div>
            <div class="input-group">
                <label>å¹´åº¦ç®¡ç†è´¹</label>
                <input type="number" id="adminFee" value="190000" oninput="calculate()">
            </div>
            <div class="input-group">
                <label>æŸè€—å æ¯” (% of GMV)</label>
                <input type="number" id="wastageRate" value="2" oninput="calculate()">
            </div>
        </div>
        
        <div class="mt-auto pt-6 border-t border-slate-100">
            <button onclick="openDonateModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all text-xs flex justify-center items-center gap-2">
                â˜• è§‰å¾—å¥½ç”¨ï¼Ÿè¯·ä½œè€…å–å’–å•¡
            </button>
        </div>
    </div>

    <!-- å³ä¾§å†…å®¹ -->
    <div class="main-content w-4/5 p-8 bg-slate-50">
        
        <!-- æ ¸å¿ƒå¡ç‰‡ -->
        <div class="grid grid-cols-4 gap-4 mb-6" id="cardContainer">
            <!-- Cards injected by JS -->
        </div>

        <!-- æŠ¥è¡¨ -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                <div>
                    <h3 class="font-bold text-slate-800" id="reportTitle">è¿è¥å€’æ¨æŸç›Šè¡¨</h3>
                    <p class="text-xs text-slate-400 mt-1" id="reportSubtitle">é€»è¾‘ï¼šåŸºäºç›®æ ‡åˆ©æ¶¦å€’æ¨é”€å”®é¢ä¸é¢„ç®—</p>
                </div>
                <div class="text-right text-xs">
                    <span class="inline-block px-2 py-1 bg-blue-50 text-blue-700 rounded font-medium" id="modeBadge">å€’æ¨æ¨¡å¼</span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="finance-table">
                    <thead>
                        <tr>
                            <th class="w-1/4">é¡¹ç›® (Item)</th>
                            <th class="w-1/6">å•æ—¥æ•°æ®</th>
                            <th class="w-1/6">æœˆåº¦æ•°æ®</th>
                            <th class="w-1/6">å¹´åº¦æ•°æ®</th>
                            <th class="w-1/6">å æ¯” (Ratio)</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

  <!-- æ‰“èµæ¨¡æ€æ¡† -->
  <div id="donateModal" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full relative overflow-hidden transform transition-all scale-100">
        <!-- å¤´éƒ¨ -->
        <div class="bg-gradient-to-r from-rose-500 to-orange-500 p-6 text-white text-center">
            <h3 class="text-xl font-bold mb-1">æ„Ÿè°¢æ‚¨çš„æ”¯æŒ</h3>
            <p class="text-white/90 text-sm">å¦‚æœè¿™ä¸ªæ¨¡å‹å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ä½œè€…å–æ¯å’–å•¡å§ â˜•</p>
            <button onclick="closeDonateModal()" class="absolute top-4 right-4 text-white/70 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        
        <!-- å†…å®¹ï¼šåŒæ”¶æ¬¾ç  -->
        <div class="p-8 flex flex-col items-center">
            <div class="flex justify-center gap-6 mb-6 w-full">
                <!-- å¾®ä¿¡ -->
                <div class="flex flex-col items-center w-1/2">
                    <div class="bg-white p-2 border border-slate-200 rounded-xl mb-2 w-full aspect-square flex items-center justify-center overflow-hidden">
                        <!-- è¯·æ›¿æ¢ä¸ºæ‚¨çš„å¾®ä¿¡æ”¶æ¬¾ç  -->
                        <img src="wx.jpg" alt="å¾®ä¿¡æ”¯ä»˜" class="w-full h-full object-contain">
                    </div>
                    <div class="flex items-center gap-1 text-slate-600 font-medium text-sm">
                        <span class="text-green-600">â—</span> å¾®ä¿¡æ”¯ä»˜
                    </div>
                </div>
                <!-- æ”¯ä»˜å® -->
                <div class="flex flex-col items-center w-1/2">
                    <div class="bg-white p-2 border border-slate-200 rounded-xl mb-2 w-full aspect-square flex items-center justify-center overflow-hidden">
                        <!-- è¯·æ›¿æ¢ä¸ºæ‚¨çš„æ”¯ä»˜å®æ”¶æ¬¾ç  -->
                        <img src="zfb.jpg" alt="æ”¯ä»˜å®" class="w-full h-full object-contain">
                    </div>
                    <div class="flex items-center gap-1 text-slate-600 font-medium text-sm">
                        <span class="text-blue-500">â—</span> æ”¯ä»˜å®
                    </div>
                </div>
            </div>

    <script>
        // æ¨¡å¼çŠ¶æ€ï¼š'target' (å€’æ¨) æˆ– 'project' (é¢„æµ‹)
        let currentMode = 'target';
        
        // åŸºç¡€æ•°æ®å®¹å™¨
        let results = {};

        // å¡ç‰‡é…ç½®
        const metricOptions = [
            { key: 'targetNetProfit', label: 'é¢„æµ‹å‡€åˆ©æ¶¦' },
            { key: 'netProfitRate', label: 'å‡€åˆ©ç‡ (Net%)' },
            { key: 'targetPaidRoi', label: 'ç»“ç®—ä»˜è´¹ ROI' }, // åç§°å¾®è°ƒ
            { key: 'marginalRoi', label: 'æ¨å¹¿ä¿æœ¬ ROI' }, 
            { key: 'storeBreakEvenRoi', label: 'å…¨åº—ä¿æœ¬ ROI' }, 
            { key: 'marketingBudget', label: 'å¹´åº¦æ¨å¹¿è´¹' },
            { key: 'dailyGmv', label: 'æ¯æ—¥ GMV' },
            { key: 'annualOrders', label: 'å¹´åº¦å‘è´§å•é‡' }
        ];

        let cardConfig = ['targetPaidRoi', 'marginalRoi', 'dailyGmv', 'marketingBudget'];

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            // é»˜è®¤è®¾ç½®ä¸ºå€’æ¨æ¨¡å¼ï¼Œå¹¶å¼ºåˆ¶è®¡ç®—ä¸€æ¬¡ï¼Œè§£å†³è¡¨æ ¼ä¸æ˜¾ç¤ºé—®é¢˜
            switchMode('target'); 
        }

        // ç›‘å¬ DOM åŠ è½½å®Œæˆï¼Œç¡®ä¿åˆå§‹åŒ–æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', init);

        function switchMode(mode) {
            currentMode = mode;
            
            // æ›´æ–° UI æ ·å¼
            document.getElementById('btnModeTarget').className = `mode-btn ${mode === 'target' ? 'active' : ''}`;
            document.getElementById('btnModeProject').className = `mode-btn ${mode === 'project' ? 'active' : ''}`;

            // åˆ‡æ¢è¾“å…¥æ˜¾ç¤º
            const targetGroup = document.getElementById('groupTargetMode');
            const projectGroup = document.getElementById('groupProjectMode');
            
            if (mode === 'target') {
                targetGroup.classList.remove('hidden-group');
                projectGroup.classList.add('hidden-group');
                document.getElementById('section1Title').innerText = '1. åˆ©æ¶¦ç›®æ ‡';
                document.getElementById('reportTitle').innerText = 'è¿è¥å€’æ¨æŸç›Šè¡¨';
                document.getElementById('reportSubtitle').innerText = 'é€»è¾‘ï¼šåŸºäºç›®æ ‡åˆ©æ¶¦å€’æ¨é”€å”®é¢ä¸é¢„ç®—';
                document.getElementById('modeBadge').innerText = 'å€’æ¨æ¨¡å¼';
                document.getElementById('modeBadge').className = 'inline-block px-2 py-1 bg-blue-50 text-blue-700 rounded font-medium';
                
                // æ¢å¤å€’æ¨æ¨¡å¼å¡ç‰‡
                cardConfig = ['targetPaidRoi', 'marginalRoi', 'dailyGmv', 'marketingBudget'];
            } else {
                targetGroup.classList.add('hidden-group');
                projectGroup.classList.remove('hidden-group');
                document.getElementById('section1Title').innerText = '1. æŠ•å…¥ä¸æ•ˆç‡';
                document.getElementById('reportTitle').innerText = 'è¿è¥é¢„æµ‹æŸç›Šè¡¨';
                document.getElementById('reportSubtitle').innerText = 'é€»è¾‘ï¼šåŸºäºæŠ•å…¥é¢„ç®—ä¸å®æ—¶ROIé¢„æµ‹æœ€ç»ˆåˆ©æ¶¦';
                document.getElementById('modeBadge').innerText = 'é¢„æµ‹æ¨¡å¼';
                document.getElementById('modeBadge').className = 'inline-block px-2 py-1 bg-green-50 text-green-700 rounded font-medium';
                
                // åˆ‡æ¢é¢„æµ‹æ¨¡å¼å¡ç‰‡
                cardConfig = ['targetNetProfit', 'netProfitRate', 'targetPaidRoi', 'storeBreakEvenRoi'];
            }
            
            renderCards();
            calculate();
        }

        const fmtMoney = (n) => 'Â¥' + n.toLocaleString('zh-CN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const fmtPct = (n) => n.toFixed(2) + '%';

        function calculate() {
            // --- 1. è·å–é€šç”¨è¾“å…¥ ---
            const grossMargin = parseFloat(document.getElementById('grossMargin').value) / 100 || 0;
            const fulfillmentFee = parseFloat(document.getElementById('fulfillmentFee').value) || 0;
            const freeTrafficRate = parseFloat(document.getElementById('freeTrafficRate').value) / 100 || 0;
            const aov = parseFloat(document.getElementById('aov').value) || 0;
            const cvr = parseFloat(document.getElementById('cvr').value) / 100 || 0;
            const returnRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0;
            const adminFee = parseFloat(document.getElementById('adminFee').value) || 0;
            const wastageRate = parseFloat(document.getElementById('wastageRate').value) / 100 || 0;
            const roiInflation = parseFloat(document.getElementById('roiInflation').value) || 1.0;
            const taxRate = 0.065; 

            // --- 2. å£°æ˜æ ¸å¿ƒå˜é‡ (è§£å†³ä½œç”¨åŸŸé—®é¢˜) ---
            let annualGmv = 0;
            let annualNetGmv = 0;
            let annualMarketing = 0;
            let targetNetProfit = 0;
            let targetPaidRoi = 0; // è¿™æ˜¯ç”¨äºè®¡ç®—çš„â€œæœ€ç»ˆç»“ç®—ROIâ€

            // --- 3. æ¨¡å¼åˆ†æµè®¡ç®— ---
            if (currentMode === 'target') {
                // === æ¨¡å¼ A: å€’æ¨ ===
                targetNetProfit = parseFloat(document.getElementById('targetProfit').value) || 0;
                const targetNetRate = parseFloat(document.getElementById('targetProfitRate').value) / 100 || 0.15;

                annualNetGmv = targetNetRate > 0 ? targetNetProfit / targetNetRate : 0;
                const effectiveSalesRate = (1 - returnRate);
                annualGmv = effectiveSalesRate > 0 ? annualNetGmv / effectiveSalesRate : 0;

            } else {
                // === æ¨¡å¼ B: é¢„æµ‹ (ä¿®æ­£ï¼šä»å®æ—¶ROIæ¨å¯¼ç»“ç®—ROI) ===
                const dailyAdSpend = parseFloat(document.getElementById('dailyAdSpend').value) || 0;
                const realtimeRoiInput = parseFloat(document.getElementById('realtimeRoiInput').value) || 0;
                
                // æ ¸å¿ƒä¿®æ­£ï¼šå®é™…ç»“ç®— ROI = å®æ—¶ ROI * è†¨èƒ€ç³»æ•°
                targetPaidRoi = realtimeRoiInput * roiInflation;
                
                // æ›´æ–°å°å­—æç¤º
                const el = document.getElementById('finalRoiPreview');
                if(el) el.innerText = targetPaidRoi.toFixed(2);

                annualMarketing = dailyAdSpend * 365;
                const paidGmv = annualMarketing * targetPaidRoi; // ç”¨è†¨èƒ€åçš„ROIç®—GMV
                
                // æ ¸å¿ƒæ­£æ¨é€»è¾‘ï¼šé€šè¿‡ä»˜è´¹GMVæ¨å¯¼æ€»GMV
                const paidTrafficRate = 1 - freeTrafficRate;
                if (paidTrafficRate <= 0.01) {
                    annualGmv = 0; 
                } else {
                    annualGmv = paidGmv / paidTrafficRate;
                }
                annualNetGmv = annualGmv * (1 - returnRate);
            }

            // --- 4. é€šç”¨æˆæœ¬ä¸åˆ©æ¶¦ç»“ç®— ---
            
            const annualReturnVal = annualGmv - annualNetGmv;
            const annualOrders = aov > 0 ? annualGmv / aov : 0;

            // æˆæœ¬é¡¹
            const annualGrossProfit = annualNetGmv * grossMargin; 
            const annualFulfillmentCost = annualOrders * fulfillmentFee; 
            const annualTax = annualNetGmv * taxRate; 
            const annualWastage = annualGmv * wastageRate; 

            // æ‹†è§£ï¼šè´§å“æˆæœ¬ (ç”¨äºè¡¨æ ¼å±•ç¤º)
            const annualTotalVariableCost = annualNetGmv * (1 - grossMargin);
            const annualProductCost = annualTotalVariableCost - annualFulfillmentCost;

            if (currentMode === 'target') {
                annualMarketing = annualGrossProfit - annualTax - annualWastage - adminFee - targetNetProfit;
                const paidTrafficRate = 1 - freeTrafficRate;
                const paidGmv = annualGmv * paidTrafficRate;
                targetPaidRoi = annualMarketing > 0 ? paidGmv / annualMarketing : 0;
            } else {
                // é¢„æµ‹æ¨¡å¼ä¸‹ï¼Œåˆ©æ¶¦æ˜¯å‰©ä¸‹çš„é’±
                targetNetProfit = annualGrossProfit - annualMarketing - annualTax - annualWastage - adminFee;
            }

            // --- 5. è¾…åŠ©æŒ‡æ ‡è®¡ç®— ---
            const paidTrafficRate = 1 - freeTrafficRate;
            const paidGmv = annualGmv * paidTrafficRate;
            
            const maxMarketingNoProfit = annualMarketing + targetNetProfit;
            const storeBreakEvenRoi = maxMarketingNoProfit > 0 ? paidGmv / maxMarketingNoProfit : 999;
            const effectiveMarginPerSale = (1 - returnRate) * (grossMargin - taxRate) - wastageRate;
            const marginalRoi = effectiveMarginPerSale > 0 ? 1 / effectiveMarginPerSale : 999;
            const netProfitRate = annualNetGmv > 0 ? (targetNetProfit / annualNetGmv) * 100 : 0;

            results = {
                targetPaidRoi: targetPaidRoi,
                targetNetProfit: targetNetProfit,
                netProfitRate: netProfitRate,
                storeBreakEvenRoi: storeBreakEvenRoi,
                marginalRoi: marginalRoi, 
                marketingBudget: annualMarketing,
                dailyGmv: annualGmv / 365,
                annualOrders: annualOrders,
                roiInflation: roiInflation
            };

            updateCardsData();

            // --- 6. æ¸²æŸ“è¡¨æ ¼ ---
            const tableData = [
                { name: 'GMV (é”€å”®é¢)', val: annualGmv, isBold: true, note: currentMode === 'target' ? 'å€’æ¨è®¡ç®—' : 'ä»˜è´¹GMV Ã· (1-å…è´¹å æ¯”)' },
                { name: '(-) é€€è´§', val: annualReturnVal, color: 'text-red-500' },
                { name: '= å‡€é”€å”®é¢ (Net Sales)', val: annualNetGmv, bg: 'bg-blue-50', isBold: true },
                { name: '(-) è´§å“ä¸å±¥çº¦æ€»æˆæœ¬', val: annualTotalVariableCost, color: 'text-slate-500', note: 'å«è¿›è´§ä»·+å¿«é€’è´¹' },
                { name: 'å…¶ä¸­ï¼šå¿«é€’æ‰“åŒ…è´¹', val: annualFulfillmentCost, isSubRow: true },
                { name: 'å…¶ä¸­ï¼šè´§å“è¿›è´§æˆæœ¬', val: annualProductCost, isSubRow: true },
                { name: '= è´¡çŒ®æ¯›åˆ©', val: annualGrossProfit, bg: 'bg-orange-50', color: 'text-orange-800', isBold: true, note: 'Net Sales Ã— å®é™…æ¯›åˆ©ç‡' },
                { name: '(-) æ¨å¹¿è´¹', val: annualMarketing, color: 'text-orange-600', isBold: true, note: currentMode === 'target' ? 'å€’æ¨é¢„ç®—' : 'æ—¥é¢„ç®— Ã— 365' },
                { name: '(-) ç¨è´¹ (6.5%)', val: annualTax, color: 'text-slate-400' },
                { name: '(-) æŸè€—', val: annualWastage, color: 'text-slate-400' },
                { name: '(-) ç®¡ç†è´¹', val: adminFee, color: 'text-slate-400' },
                { name: '= å‡€åˆ©æ¶¦', val: targetNetProfit, color: targetNetProfit > 0 ? 'text-green-600' : 'text-red-600', bg: targetNetProfit > 0 ? 'bg-green-50' : 'bg-red-50', isBold: true, isTotal: true }
            ];

            renderTable(tableData, annualGmv);
        }

        // --- è§†å›¾æ¸²æŸ“å‡½æ•° ---

        function renderCards() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';
            cardConfig.forEach((key, index) => {
                const opt = metricOptions.find(o => o.key === key);
                const div = document.createElement('div');
                div.className = 'stat-card';
                div.innerHTML = `
                    <select class="card-select" onchange="changeCard(${index}, this.value)">
                        ${metricOptions.map(o => `<option value="${o.key}" ${o.key === key ? 'selected' : ''}>${o.label}</option>`).join('')}
                    </select>
                    <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mt-1 mb-2" id="card-label-${index}">
                        ${opt ? opt.label : ''}
                    </div>
                    <div id="card-val-${index}" class="flex flex-col items-start justify-center h-16"></div>
                    <div class="text-xs text-slate-400 mt-2 font-medium" id="card-sub-${index}">...</div>
                `;
                container.appendChild(div);
            });
            updateCardsData();
        }

        function updateCardsData() {
            cardConfig.forEach((key, index) => {
                const valContainer = document.getElementById(`card-val-${index}`);
                const subEl = document.getElementById(`card-sub-${index}`);
                const labelEl = document.getElementById(`card-label-${index}`);
                const opt = metricOptions.find(o => o.key === key);
                if(labelEl) labelEl.innerText = opt.label;

                if (!valContainer) return;
                valContainer.innerHTML = '';
                let subText = '';

                // 1. å¤„ç† ROI ç±»æ˜¾ç¤º
                if (key === 'targetPaidRoi') {
                    // è¿™é‡Œ results.targetPaidRoi æ°¸è¿œæ˜¯â€œæœ€ç»ˆç»“ç®—ROIâ€
                    const finalRoi = results.targetPaidRoi;
                    // åæ¨æ˜¾ç¤ºçš„å®æ—¶ROI
                    const realtimeRoi = finalRoi / results.roiInflation;
                    
                    valContainer.innerHTML = `
                        <div class="text-2xl font-bold text-slate-700 leading-none">${finalRoi.toFixed(2)}</div>
                        <div class="flex items-center gap-1 mt-1 bg-slate-100 px-2 py-0.5 rounded">
                            <span class="text-[10px] text-slate-400">å®æ—¶â‰ˆ</span>
                            <span class="text-sm font-bold text-slate-600">${realtimeRoi.toFixed(2)}</span>
                        </div>
                    `;
                    subText = currentMode === 'target' ? 'å€’æ¨ç›®æ ‡ç»“ç®—å€¼' : 'åŸºäºå®æ—¶è¾“å…¥æ¨ç®—';

                } else if (key === 'marginalRoi') {
                    const val = results[key];
                    const realtimeVal = val / results.roiInflation;
                    valContainer.innerHTML = `
                        <div class="text-2xl font-bold text-red-600 leading-none">${val.toFixed(2)}</div>
                        <div class="flex items-center gap-1 mt-1 bg-slate-100 px-2 py-0.5 rounded">
                            <span class="text-[10px] text-slate-400">å®æ—¶ä¿æœ¬</span>
                            <span class="text-sm font-bold text-slate-600">${realtimeVal.toFixed(2)}</span>
                        </div>
                    `;
                    subText = 'ä½äºæ­¤å€¼å³äºæŸ';
                
                } else if (key === 'targetNetProfit') {
                    const val = results.targetNetProfit;
                    const colorClass = val >= 0 ? 'text-green-600' : 'text-red-600';
                    valContainer.innerHTML = `<div class="text-2xl font-bold ${colorClass}">${fmtMoney(val)}</div>`;
                    subText = currentMode === 'project' ? 'åŸºäºå½“å‰æŠ•å…¥é¢„æµ‹' : 'è®¾å®šç›®æ ‡';

                } else {
                    let displayVal = results[key];
                    if (key.includes('Budget') || key.includes('Gmv')) displayVal = fmtMoney(displayVal);
                    else if (key.includes('Rate')) displayVal = fmtPct(displayVal);
                    else if (key.includes('Orders')) displayVal = Math.round(displayVal).toLocaleString();
                    else displayVal = typeof displayVal === 'number' ? displayVal.toFixed(2) : displayVal;

                    valContainer.innerHTML = `<div class="text-2xl font-bold text-slate-700">${displayVal}</div>`;
                    
                    if(key === 'storeBreakEvenRoi') subText = 'å…¨åº—ä¸äºé’±åº•çº¿';
                    if(key === 'marketingBudget') subText = 'å¹´åº¦æ€»é¢„ç®—æ± ';
                }

                if(subEl) subEl.innerText = subText;
            });
        }

        function changeCard(index, newKey) {
            cardConfig[index] = newKey;
            updateCardsData();
        }

        function renderTable(data, totalGmv) {
            const tbody = document.getElementById('reportTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                if (row.bg) tr.className = row.bg;
                if (row.isSubRow) tr.className = 'sub-row';
                
                const daily = row.val / 365;
                const monthly = row.val / 12;
                const annual = row.val;
                
                let ratio = totalGmv > 0 ? (row.val / totalGmv * 100) : 0;
                
                tr.innerHTML = `
                    <td>
                        <div class="${row.isTotal ? 'text-base' : 'text-sm'} ${row.isBold ? 'font-bold text-slate-800' : ''}">
                            ${row.name}
                        </div>
                        ${row.note ? `<div class="text-[10px] text-slate-400 font-normal mt-0.5">${row.note}</div>` : ''}
                    </td>
                    <td class="${row.color || 'text-slate-600'} ${row.isBold ? 'font-bold' : ''}">${row.isSubRow ? '' : fmtMoney(daily)}</td>
                    <td class="${row.color || 'text-slate-600'} ${row.isBold ? 'font-bold' : ''}">${row.isSubRow ? '' : fmtMoney(monthly)}</td>
                    <td class="${row.color || 'text-slate-600'} ${row.isBold ? 'font-bold' : ''} text-slate-800 bg-opacity-50">${fmtMoney(annual)}</td>
                    <td class="text-slate-400 text-xs">${row.isSubRow ? '' : fmtPct(ratio)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openDonateModal() { document.getElementById('donateModal').classList.remove('hidden'); }
        function closeDonateModal() { document.getElementById('donateModal').classList.add('hidden'); }
    </script>
</body>
</html>
